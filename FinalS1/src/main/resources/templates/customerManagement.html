<!-- 後台管理員前端 -->
<!DOCTYPE html>
<html lang="zh-TW">
<head th:include="CMShead">
</head>
<body>
<title>後台管理員聊天</title>

<!-- 通知按鈕 -->
<button id="adminChatButton" class="btn btn-warning" style="position: fixed; bottom: 20px; right: 20px;">新訊息，點擊查看</button>

<div id="adminChatContainer" class="container mt-5"></div> <!-- 管理员聊天窗口容器 -->

<script>
document.addEventListener("DOMContentLoaded", function() {
    var adminSocket = new WebSocket("ws://localhost:8080/chat?admin=true");
    adminSocket.onopen = function() {
        console.log("管理员 WebSocket 连接已建立");
    };

    adminSocket.onclose = function() {
        console.log("管理员 WebSocket 连接已关闭");
    };
    adminSocket.onmessage = function(event) {
        console.log("收到消息:", event.data);
        var data = event.data.split(":");
        
        if (data.length === 2) {
            var userUUID = data[0];
            var message = data[1];
            openAdminChatWindow(userUUID, message);
            flashNewMessageButton();
        } else {
            console.error("消息格式不正确:", event.data);
        }
    };

    function flashNewMessageButton() {
        var button = document.getElementById("adminChatButton");
        button.classList.add("btn-flashing");
        setTimeout(() => {
            button.classList.remove("btn-flashing");
        }, 3000);
    }

    function openAdminChatWindow(userUUID, message) {
        let chatWindow = document.getElementById("adminChatContainer").querySelector(`#chatWindow-${userUUID}`);
        
        if (!chatWindow) {
            chatWindow = document.createElement("div");
            chatWindow.className = "chat-window";
            chatWindow.id = `chatWindow-${userUUID}`;
            chatWindow.innerHTML = `
                <div class="chat-header d-flex justify-content-between">
                    <span>用戶 ${userUUID}</span>
                    <button type="button" class="close" onclick="closeAdminChat('${userUUID}')">&times;</button>
                </div>
                <div class="chat-body" id="chatBox-${userUUID}"></div>
                <div class="chat-footer d-flex">
                    <input type="text" id="adminMessageInput-${userUUID}" class="form-control" placeholder="输入消息...">
                    <button type="button" class="btn btn-primary ml-2" onclick="sendAdminMessage('${userUUID}')">发送</button>
                </div>`;
            document.getElementById("adminChatContainer").appendChild(chatWindow);
        }

        var chatBox = document.getElementById(`chatBox-${userUUID}`);
        chatBox.innerHTML += `<p>${message}</p>`;
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function sendAdminMessage(userUUID) {
        var input = document.getElementById(`adminMessageInput-${userUUID}`);
        var message = input.value;
        if (message.trim() !== "") {
        	console.log(`发送消息给: ${userUUID}: ${message}`);
            adminSocket.send("admin:" + userUUID + ":" + message);
            input.value = "";
        }
    }

    function closeAdminChat(userUUID) {
        var chatWindow = document.getElementById(`chatWindow-${userUUID}`);
        chatWindow.parentNode.removeChild(chatWindow);
    }

    window.sendAdminMessage = sendAdminMessage; // 暴露到全局
});

</script>

<footer th:include="CMSfooter"></footer>
</body>
</html>
