<!DOCTYPE html>
<html lang="en">
<head>
<title>Vegefoods - Free Bootstrap 4 Template by Colorlib</title>
<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link
	href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,500,600,700,800&display=swap"
	rel="stylesheet">
<link
	href="https://fonts.googleapis.com/css?family=Lora:400,400i,700,700i&display=swap"
	rel="stylesheet">
<link
	href="https://fonts.googleapis.com/css?family=Amatic+SC:400,700&display=swap"
	rel="stylesheet">

<link rel="stylesheet" href="css/open-iconic-bootstrap.min.css">
<link rel="stylesheet" href="css/animate.css">

<link rel="stylesheet" href="css/owl.carousel.min.css">
<link rel="stylesheet" href="css/owl.theme.default.min.css">
<link rel="stylesheet" href="css/magnific-popup.css">

<link rel="stylesheet" href="css/aos.css">

<link rel="stylesheet" href="css/ionicons.min.css">

<link rel="stylesheet" href="css/bootstrap-datepicker.css">
<link rel="stylesheet" href="css/jquery.timepicker.css">


<link rel="stylesheet" href="css/flaticon.css">
<link rel="stylesheet" href="css/icomoon.css">
<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="css/custom.css">
</head>
<body class="goto-here">

	<div class="container">
		<div>
			<form action="#" class="search-form">
				<div class="form-group">
					<span class="icon ion-ios-search"></span> <input type="text"
						class="form-control" placeholder="搜尋...">
				</div>
			</form>
		</div>
	</div>
	<nav class="navbar navbar-expand-lg navbar-dark ftco_navbar bg-dark ftco-navbar-light"
		id="ftco-navbar">
		<div class="container">

			<a class="navbar-brand" href="Home.html">WEARTOWEAR</a>
			<button class="navbar-toggler" type="button" data-toggle="collapse"
				data-target="#ftco-nav" aria-controls="ftco-nav"
				aria-expanded="false" aria-label="Toggle navigation">
				<span class="oi oi-menu"></span> Menu
			</button>

			<div class="collapse navbar-collapse col" id="ftco-nav">
				<ul class="navbar-nav ml-auto">
					<li class="nav-item"><a href="Home.html" class="nav-link">首頁</a></li>
					<li class="nav-item"><a href="AboutUs.html" class="nav-link">關於我們</a></li>

					<li class="nav-item dropdown"><a
						class="nav-link dropdown-toggle" href="shop.html" id="dropdown04"
						data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">商品</a>
						<div class="dropdown-menu" aria-labelledby="dropdown04">
							<a class="dropdown-item" href="shop.html">所有商品</a> <a
								class="dropdown-item" href="shop.html?category=1">男裝</a> <a
								class="dropdown-item" href="shop.html?category=2">女裝</a> <a
								class="dropdown-item" href="shop.html?category=3">童裝</a>
						</div></li>



					<!-- <li class="nav-item"><a href="blog.html" class="nav-link">Blog</a></li> -->
					<li class="nav-item"><a href="contact.html" class="nav-link">聯繫我們</a></li>

					<!-- <li class="nav-item dropdown cta cta-colored"><a href="#"
						class="nav-link" id="sessionCheck"><span class="icon-person"></span></a>
						<div class="dropdown-menu dropdown-menu-center"
							aria-labelledby="sessionCheck">
							<a class="dropdown-item" href="#">會員中心</a> <a
								class="dropdown-item" href="#">登出</a>
						</div></li> -->

					<li class="nav-item dropdown cta cta-colored"><a href="#"
						class="nav-link " id="sessionCheck" data-toggle="dropdown"
						aria-haspopup="true" aria-expanded="false"> <span
							class="icon-person"></span>
					</a>
						<div class="dropdown-menu" id="userDropdown"
							style="display: none;">
							<a class="dropdown-item" href="/Account.html">會員中心</a> <a
								class="dropdown-item" href="#" id="logoutButton">登出</a>
						</div></li>
					<li class="nav-item cta cta-colored"><a href="wishlist.html"
						class="nav-link" id="icon-wish"><span class="icon-heart"></span></a></li>
					<li class="nav-item cta cta-colored">
						<a href="cart.html"class="nav-link" id="cart-icon">
							<span class="icon-shopping_cart"></span>[<span id="cart-count">0</span>]
						</a>
					</li>

				</ul>
			</div>
		</div>
	</nav>
	<!-- END nav -->

	<div class="hero-wrap hero-bread"
		style="background-image: url(./Picture/pagepic/2.png);">
		<div class="container">
			<div
				class="row no-gutters slider-text align-items-center justify-content-center">
				<div class="col-md-9 ftco-animate text-center">
					<p class="breadcrumbs">
						<span class="mr-2"><a href="index.html"></a></span> <span></span>
					</p>
					<h1 class="mb-0 bread">My Cart</h1>
				</div>
			</div>
		</div>
	</div>

	<section class="ftco-section ftco-cart">
		<div class="container">
			<div class="row" id="cart-item-table" style="display: none;">
				<div class="col-md-12 ftco-animate">
					<div class="cart-list">
						<table class="table">
							<thead class="thead-primary">
								<tr class="text-center">
									<th>&nbsp;</th>
									<th>&nbsp;</th>
									<th>商品名稱</th>
									<th>尺寸</th>
									<th>價格</th>
									<th>數量</th>
									<th>總金額</th>
								</tr>
							</thead>
							<tbody id="cart-items-body">
								<!--  商品顯示位置 -->
							</tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- 優惠券&總價 -->
			<div class="row justify-content-end" id="cart-summary-section" style="display: none;">
				<div class="col-lg-5 mt-5 cart-wrap ftco-animate">
					<div class="cart-total mb-3">
						<h3>優惠券</h3>
						<form action="#" class="info">
							<div class="form-group">
								<label for="">請輸入優惠序號</label> <input type="text"
									class="form-control text-left px-3" placeholder="">
							</div>
						</form>
					</div>
				</div>
				<div class="col-lg-2 mt-5 cart-wrap ftco-animate"></div>
				<div class="col-lg-5 mt-5 cart-wrap ftco-animate">
					<div class="cart-total mb-3">
						<h3>付款詳情</h3>
						<p class="d-flex">
							<span>商品總額</span> <span class="subtotal">$0.00</span>
						</p>
						<p class="d-flex">
							<span>運費</span> <span class="shipping">$0.00</span>
						</p>
						<p class="d-flex">
							<span>優惠折扣</span> <span class="discount">$0.00</span>
						</p>
						<hr>
						<p class="d-flex total-price">
							<span>總付款金額</span> <span class="total-price">$0.00</span>
						</p>
					</div>
					<p>
						<a href="checkout.html" class="btn btn-primary py-3 px-4">結帳</a>
					</p>
				</div>
			</div>
		</div>
		
		
		<section class="ftco-section ftco-cart" id="empty-cart-container">
		<!-- 沒有商品顯示區域 -->
		</section>
		
		<!-- 刪除modal -->
		<div id="confirmModal" class="modalForUS">
			<div class="modal-content">
				<p>確定要刪除此商品嗎？</p>
				<button id="confirmDelete" class="btn btn-danger1">確定</button>
				<button id="cancelDelete" class="btn btn-secondary1">取消</button>
			</div>
		</div>


	</section>




	<section class="ftco-section ftco-no-pt ftco-no-pb py-5 bg-light">
		<div class="container py-4">
			<div class="row d-flex justify-content-center py-5">
				<div class="col-md-6">
					<h2 style="font-size: 22px;" class="mb-0">Subcribe to our
						Newsletter</h2>
					<span>Get e-mail updates about our latest shops and special
						offers</span>
				</div>
				<div class="col-md-6 d-flex align-items-center">
					<form action="#" class="subscribe-form">
						<div class="form-group d-flex">
							<input type="text" class="form-control"
								placeholder="Enter email address"> <input type="submit"
								value="Subscribe" class="submit px-3">
						</div>
					</form>
				</div>
			</div>
		</div>
	</section>
	<footer class="ftco-footer ftco-section">
		<div class="container">
			<div class="row">
				<div class="mouse">
					<a href="#" class="mouse-icon">
						<div class="mouse-wheel">
							<span class="ion-ios-arrow-up"></span>
						</div>
					</a>
				</div>
			</div>
			<div class="row mb-5">
				<div class="col-md">
					<div class="ftco-footer-widget mb-4">
						<h2 class="ftco-heading-2">Vegefoods</h2>
						<p>Far far away, behind the word mountains, far from the
							countries Vokalia and Consonantia.</p>
						<ul
							class="ftco-footer-social list-unstyled float-md-left float-lft mt-5">
							<li class="ftco-animate"><a href="#"><span
									class="icon-twitter"></span></a></li>
							<li class="ftco-animate"><a href="#"><span
									class="icon-facebook"></span></a></li>
							<li class="ftco-animate"><a href="#"><span
									class="icon-instagram"></span></a></li>
						</ul>
					</div>
				</div>
				<div class="col-md">
					<div class="ftco-footer-widget mb-4 ml-md-5">
						<h2 class="ftco-heading-2">Menu</h2>
						<ul class="list-unstyled">
							<li><a href="#" class="py-2 d-block">Shop</a></li>
							<li><a href="#" class="py-2 d-block">About</a></li>
							<li><a href="#" class="py-2 d-block">Journal</a></li>
							<li><a href="#" class="py-2 d-block">Contact Us</a></li>
						</ul>
					</div>
				</div>
				<div class="col-md-4">
					<div class="ftco-footer-widget mb-4">
						<h2 class="ftco-heading-2">Help</h2>
						<div class="d-flex">
							<ul class="list-unstyled mr-l-5 pr-l-3 mr-4">
								<li><a href="#" class="py-2 d-block">Shipping
										Information</a></li>
								<li><a href="#" class="py-2 d-block">Returns &amp;
										Exchange</a></li>
								<li><a href="#" class="py-2 d-block">Terms &amp;
										Conditions</a></li>
								<li><a href="#" class="py-2 d-block">Privacy Policy</a></li>
							</ul>
							<ul class="list-unstyled">
								<li><a href="#" class="py-2 d-block">FAQs</a></li>
								<li><a href="#" class="py-2 d-block">Contact</a></li>
							</ul>
						</div>
					</div>
				</div>
				<div class="col-md">
					<div class="ftco-footer-widget mb-4">
						<h2 class="ftco-heading-2">Have a Questions?</h2>
						<div class="block-23 mb-3">
							<ul>
								<li><span class="icon icon-map-marker"></span><span
									class="text">203 Fake St. Mountain View, San Francisco,
										California, USA</span></li>
								<li><a href="#"><span class="icon icon-phone"></span><span
										class="text">+2 392 3929 210</span></a></li>
								<li><a href="#"><span class="icon icon-envelope"></span><span
										class="text">info@yourdomain.com</span></a></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</footer>



	<!-- loader -->
	<div id="ftco-loader" class="show fullscreen">
		<svg class="circular" width="48px" height="48px">
			<circle class="path-bg" cx="24" cy="24" r="22" fill="none"
				stroke-width="4" stroke="#eeeeee" />
			<circle class="path" cx="24" cy="24" r="22" fill="none"
				stroke-width="4" stroke-miterlimit="10" stroke="#F96D00" /></svg>
	</div>


	<script src="js/jquery.min.js"></script>
	<script src="js/jquery-migrate-3.0.1.min.js"></script>
	<script src="js/popper.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/jquery.easing.1.3.js"></script>
	<script src="js/jquery.waypoints.min.js"></script>
	<script src="js/jquery.stellar.min.js"></script>
	<script src="js/owl.carousel.min.js"></script>
	<script src="js/jquery.magnific-popup.min.js"></script>
	<script src="js/aos.js"></script>
	<script src="js/jquery.animateNumber.min.js"></script>
	<script src="js/bootstrap-datepicker.js"></script>
	<script src="js/scrollax.min.js"></script>
	<script
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBVWaKrjvy3MaE7SQ74_uJiULgl1JY0H2s&sensor=false"></script>
	<script src="js/google-map.js"></script>
	<script src="js/main.js"></script>
	<script src="myjs/leo.js"></script>
	<script src="myjs/cartCount.js"></script>
	<script src="myjs/session.js"></script>
	<script src="myjs/logout.js"></script>
	<script>
		
	document.addEventListener('DOMContentLoaded', function() {   
	    fetchCartItems();
	});

	// 購物車數據
	function fetchCartItems() {
	    fetch('/cart/items')
	        .then(response => {
	            if (!response.ok) {
	                throw new Error('Network response was not ok');
	            }
	            return response.json();
	        })
	        .then(cartItems => {
	            displayCartItems(cartItems); 
	            
	            const cartSummarySection = document.getElementById('cart-summary-section');
	            const cartItemTable = document.getElementById('cart-item-table');
	            const emptyCartContainer = document.getElementById('empty-cart-container')
	            
	            if (cartItems.length > 0) {
	            	cartSummarySection.style.display = 'flex';
	            	cartItemTable.style.display = 'flex';	
	            	
	            	emptyCartContainer.innerHTML = '';
	            } else {		            	
	            	cartSummarySection.style.display = 'none';
	            	cartItemTable.style.display = 'none';
	            	
	            	emptyCartContainer.innerHTML = '';
	            	const emptyCart = document.createElement('div');
	            	
	            	emptyCart.innerHTML = `
	            	<div class="container text-center">
	            		<h5>您的購物車沒有商品</h5>
		            	<a href="shop.html">查看更多商品</a>
	            	</div>
	            	
	            	`;
	            	
	            	emptyCartContainer.appendChild(emptyCart);
	            }
	        })
	        .catch(error => console.error('Error fetching cart items:', error));
	}


	// 將購物車內容丟到頁面
	function displayCartItems(cartItems) {
	    const cartItemsBody = document.getElementById('cart-items-body');
	    cartItemsBody.innerHTML = '';  // 清空之前的内容
	    let subtotal = 0;
	    
	    const promises = cartItems.map(item => {
	    	 // 向後端請求最新的 productVariant 價格
	        return fetch(`/product-variants/${item.productVariant.id}`)
	            .then(response => {
	                if (!response.ok) {
	                    throw new Error('Failed to fetch product variant price');
	                }
	                return response.json();
	            })
	            .then(data => {
	                // 更新該商品的價格
	                item.price = data.price;
	                return item;
	            })
	            .catch(error => {
	                console.error('Error fetching latest price:', error);
	                return item; // 確保繼續處理即使某些請求失敗
	            });
	    });
	
	    Promise.all(promises).then(updatedCartItems => {
	    	updatedCartItems.forEach(item => {	    	
	        const row = document.createElement('tr');
	        row.classList.add('text-center');

	        row.innerHTML = `
	            <td class="product-remove" data-id="${item.id}"><a href="#" class="delete-item"><span class="ion-ios-close"></span></a></td>
	            <td class="image-prod">
	                <img src="data:image/jpeg;base64,${item.productVariant.product.image}" style="width:150px;height:200px;">
	            </td>
	            <td class="product-name">
	                <h3>${item.productVariant.product.name}</h3>
	                <p>${item.productVariant.product.description}</p>
	            </td>
	            <td class="cart-size">${item.productVariant.size.name}</td>
	            <td class="price">NT$${item.price.toFixed(2)}</td>
	            <td class="quantity">
	                <div class="input-group mb-3">
	                    <input type="number" name="quantity" class="quantity form-control input-number" value="${item.quantity}" min="1" max="10" data-variant-id="${item.productVariant.id}">
	                </div>
	            </td>
	            <td class="total">NT$${(item.price * item.quantity).toFixed(2)}</td>
	        `;

	        cartItemsBody.appendChild(row);
	        subtotal += item.price * item.quantity; // 類季商品總價

	        // 數量框確認
	        const quantityInput = row.querySelector('.quantity input');
	        quantityInput.addEventListener('change', function() {
	            const newQuantity = parseInt(this.value);
	            console.log('新數量:', newQuantity);
	            const variantId = this.getAttribute('data-variant-id');

	            if (newQuantity > 0) {
	                // 更新數量
	                fetch('/cart/update', {
	                    method: 'POST',
	                    headers: {
	                        'Content-Type': 'application/json'
	                    },
	                    body: JSON.stringify({
	                        variantId: variantId,
	                        quantity: newQuantity
	                    })
	                })
	                .then(response => {
	                    if (!response.ok) {
	                        return response.json().then(err => {
	                            throw new Error(err.message || '更新購物車失敗');
	                        });
	                    }
	                    return response.json(); // 返回 JSON
	                })
	                .then(cartData => {
	                    if (cartData.success) {
	                        console.log('更新購物車的數據:', cartData);
	                        displayCartItems(cartData.cartItems); // 使用返回的 cartItems 更新显示
	                    } else {
	                        alert('更新購物車失敗!請重試。');
	                    }
	                })
	                .catch(error => console.error('Error updating cart:', error));
	            } else {
	                alert('數量不可小於1');
	                this.value = 1; // 重置回1
	            }
	        });
	    });
	 
	    updatePaymentDetails(subtotal); // foreach完後再更新
	   });
	}

	function updatePaymentDetails(subtotal) {
	    const shipping = 0.00; // 運費0
	    const discount = 0.00; // 折扣0
	    const total = subtotal + shipping - discount;

	    document.querySelector('.cart-total .subtotal').innerText = `NT$${subtotal.toFixed(2)}`;
	    document.querySelector('.cart-total .shipping').innerText = `NT$${shipping.toFixed(2)}`;
	    document.querySelector('.cart-total .discount').innerText = `NT$${discount.toFixed(2)}`;
	    document.querySelector('.cart-total .total-price').innerText = `NT$${total.toFixed(2)}`;
	}
								

	// 刪除
	document.addEventListener('click', function(event) {
	    if (event.target.closest('.delete-item')) {
	        event.preventDefault();
	        
	        const row = event.target.closest('tr');
	        const itemId = event.target.closest('.product-remove').dataset.id;
	        
	        //彈出框
	        const confirmModal = document.getElementById('confirmModal');
	                confirmModal.style.display = 'flex';
	                
	                document.getElementById('confirmDelete').onclick = function () {
	                    // 如果用戶確認，則執行刪除操作
	                   deleteCartItem(itemId, row);
	                    confirmModal.style.display = 'none';
	                };

	                document.getElementById('cancelDelete').onclick = function () {
	                    // 如果用戶取消，隱藏模態框
	                    confirmModal.style.display = 'none';
	                };
	    }
	});

	function deleteCartItem(itemId, row) {
			fetch(`/cart/delete`, {
		        method: 'DELETE',
		        headers: {
		            'Content-Type': 'application/json',
		        },
		        body: JSON.stringify({ id: itemId }), // 發送請求，包含商品 ID
		    })
		    .then(response => {
		        if (!response.ok) {
		            throw new Error('Failed to delete item');
		        }
		        return response.text(); // 期待回傳的文字訊息
		    })
		    .then(data => {
		    	console.log('Item deleted successfully:', data);
		    	row.remove();
		    	
		    	fetchCartItems();  // 重新獲取購物車商品以更新介面 	
		    })

		    .catch(error => console.error('Error deleting item:', error));
		}

		
		$(document).ready(function(){

		var quantitiy=0;
		   $('.quantity-right-plus').click(function(e){
		        
		        // Stop acting like a button
		        e.preventDefault();
		        // Get the field name
		        var quantity = parseInt($('#quantity').val());
		        
		        // If is not undefined
		            
		            $('#quantity').val(quantity + 1);

		          
		            // Increment
		        
		    });

		     $('.quantity-left-minus').click(function(e){
		        // Stop acting like a button
		        e.preventDefault();
		        // Get the field name
		        var quantity = parseInt($('#quantity').val());
		        
		        // If is not undefined
		      
		            // Increment
		            if(quantity>0){
		            $('#quantity').val(quantity - 1);
		            }
		    });
		});

	</script>

</body>
</html>